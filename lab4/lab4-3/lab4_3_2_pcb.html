<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>设计关键数据结构 &mdash; 2023级NKU操作系统实验指导书 1.1.0 文档</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=ab4a11d3"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../../_static/translations.js?v=beaddf03"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="next" title="创建并执行内核线程" href="lab4_3_3_create_exec_kernel_thread.html" />
    <link rel="prev" title="实验执行流程概述" href="lab4_3_1_lab_steps.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            2023级NKU操作系统实验指导书
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="搜索文档" aria-label="搜索文档" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="导航菜单">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../README/README.html">欢迎来到ucore step-by-step的世界</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../lab0/index.html">lab0: 预备起</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../lab0.5/index.html">lab0.5: 比麻雀更小的麻雀(最小可执行内核)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../lab1/index.html">lab1: 断, 都可以断</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../lab2/index.html">lab2:物理内存和页表</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../lab3/index.html">lab3:缺页异常和页面置换</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">lab4:进程管理</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../index.html#id1">本章内容</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../lab4-1/lab4_1_goals.html">实验目的</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lab4-2/index.html">实验内容</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">内核线程管理</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="index.html#id2">进程与线程</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#id4">我们为什么需要进程</a></li>
<li class="toctree-l4 current"><a class="reference internal" href="index.html#id6">本节内容</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../lab4-4/lab4_4_labs_requirement.html">实验报告要求</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../lab5/index.html">lab5:用户程序</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../lab6/index.html">lab6 进程调度</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../lab7/index.html">lab7 同步互斥</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../lab8/index.html">Lab8 文件系统</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../appendix/index.html">附录</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="移动版导航菜单" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">2023级NKU操作系统实验指导书</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="页面导航">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">lab4:进程管理</a></li>
          <li class="breadcrumb-item"><a href="index.html">内核线程管理</a></li>
      <li class="breadcrumb-item active">设计关键数据结构</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/lab4/lab4-3/lab4_3_2_pcb.md.txt" rel="nofollow"> 查看页面源码</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="id1">
<h1>设计关键数据结构<a class="headerlink" href="#id1" title="Link to this heading"></a></h1>
<section id="id2">
<h2>进程控制块<a class="headerlink" href="#id2" title="Link to this heading"></a></h2>
<p>在实验四中，进程管理信息用struct
proc_struct表示，在<em>kern/process/proc.h</em>中定义如下：</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">proc_struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">enum</span><span class="w"> </span><span class="n">proc_state</span><span class="w"> </span><span class="n">state</span><span class="p">;</span><span class="w">                  </span><span class="c1">// Process state</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">;</span><span class="w">                                </span><span class="c1">// Process ID</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">runs</span><span class="p">;</span><span class="w">                               </span><span class="c1">// the running times of Proces</span>
<span class="w">    </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">kstack</span><span class="p">;</span><span class="w">                       </span><span class="c1">// Process kernel stack</span>
<span class="w">    </span><span class="k">volatile</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">need_resched</span><span class="p">;</span><span class="w">             </span><span class="c1">// bool value: need to be rescheduled to release CPU?</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">proc_struct</span><span class="w"> </span><span class="o">*</span><span class="n">parent</span><span class="p">;</span><span class="w">             </span><span class="c1">// the parent process</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mm_struct</span><span class="w"> </span><span class="o">*</span><span class="n">mm</span><span class="p">;</span><span class="w">                   </span><span class="c1">// Process&#39;s memory management field</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">context</span><span class="w"> </span><span class="n">context</span><span class="p">;</span><span class="w">                 </span><span class="c1">// Switch here to run process</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">trapframe</span><span class="w"> </span><span class="o">*</span><span class="n">tf</span><span class="p">;</span><span class="w">                   </span><span class="c1">// Trap frame for current interrupt</span>
<span class="w">    </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">cr3</span><span class="p">;</span><span class="w">                          </span><span class="c1">// CR3 register: the base addr of Page Directroy Table(PDT)</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">flags</span><span class="p">;</span><span class="w">                         </span><span class="c1">// Process flag</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">name</span><span class="p">[</span><span class="n">PROC_NAME_LEN</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span><span class="w">           </span><span class="c1">// Process name</span>
<span class="w">    </span><span class="n">list_entry_t</span><span class="w"> </span><span class="n">list_link</span><span class="p">;</span><span class="w">                 </span><span class="c1">// Process link list </span>
<span class="w">    </span><span class="n">list_entry_t</span><span class="w"> </span><span class="n">hash_link</span><span class="p">;</span><span class="w">                 </span><span class="c1">// Process hash list</span>
<span class="p">};</span>
</pre></div>
</div>
<p>下面重点解释一下几个比较重要的成员变量：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">mm</span></code>：这里面保存了内存管理的信息，包括内存映射，虚存管理等内容。具体内在实现可以参考之前的章节。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">state</span></code>：进程所处的状态。uCore中进程状态有四种：分别是<code class="docutils literal notranslate"><span class="pre">PROC_UNINIT</span></code>、<code class="docutils literal notranslate"><span class="pre">PROC_SLEEPING</span></code>、<code class="docutils literal notranslate"><span class="pre">PROC_RUNNABLE</span></code>、<code class="docutils literal notranslate"><span class="pre">PROC_ZOMBIE</span></code>。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">parent</span></code>：里面保存了进程的父进程的指针。在内核中，只有内核创建的idle进程没有父进程，其他进程都有父进程。进程的父子关系组成了一棵进程树，这种父子关系有利于维护父进程对于子进程的一些特殊操作。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">context</span></code>：<code class="docutils literal notranslate"><span class="pre">context</span></code>中保存了进程执行的上下文，也就是几个关键的寄存器的值。这些寄存器的值用于在进程切换中还原之前进程的运行状态（进程切换的详细过程在后面会介绍）。切换过程的实现在<code class="docutils literal notranslate"><span class="pre">kern/process/switch.S</span></code>。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tf</span></code>：<code class="docutils literal notranslate"><span class="pre">tf</span></code>里保存了进程的中断帧。当进程从用户空间跳进内核空间的时候，进程的执行状态被保存在了中断帧中（注意这里需要保存的执行状态数量不同于上下文切换）。系统调用可能会改变用户寄存器的值，我们可以通过调整中断帧来使得系统调用返回特定的值。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cr3</span></code>：<code class="docutils literal notranslate"><span class="pre">cr3</span></code>寄存器是x86架构的特殊寄存器，用来保存页表所在的基址。出于legacy的原因，我们这里仍然保留了这个名字，但其值仍然是页表基址所在的位置。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">kstack</span></code>: 每个线程都有一个内核栈，并且位于内核地址空间的不同位置。对于内核线程，该栈就是运行时的程序使用的栈；而对于普通进程，该栈是发生特权级改变的时候使保存被打断的硬件信息用的栈。uCore在创建进程时分配了 2 个连续的物理页（参见memlayout.h中KSTACKSIZE的定义）作为内核栈的空间。这个栈很小，所以内核中的代码应该尽可能的紧凑，并且避免在栈上分配大的数据结构，以免栈溢出，导致系统崩溃。kstack记录了分配给该进程/线程的内核栈的位置。主要作用有以下几点。首先，当内核准备从一个进程切换到另一个的时候，需要根据kstack 的值正确的设置好 tss （可以回顾一下在实验一中讲述的 tss 在中断处理过程中的作用），以便在进程切换以后再发生中断时能够使用正确的栈。其次，内核栈位于内核地址空间，并且是不共享的（每个线程都拥有自己的内核栈），因此不受到 mm 的管理，当进程退出的时候，内核能够根据 kstack 的值快速定位栈的位置并进行回收。uCore 的这种内核栈的设计借鉴的是 linux 的方法（但由于内存管理实现的差异，它实现的远不如 linux 的灵活），它使得每个线程的内核栈在不同的位置，这样从某种程度上方便调试，但同时也使得内核对栈溢出变得十分不敏感，因为一旦发生溢出，它极可能污染内核中其它的数据使得内核崩溃。如果能够通过页表，将所有进程的内核栈映射到固定的地址上去，能够避免这种问题，但又会使得进程切换过程中对栈的修改变得相当繁琐。感兴趣的同学可以参考 linux kernel 的代码对此进行尝试。</p></li>
</ul>
<p>为了管理系统中所有的进程控制块，uCore维护了如下全局变量（位于<em>kern/process/proc.c</em>）：</p>
<p>● static struct proc *current：当前占用CPU且处于“运行”状态进程控制块指针。通常这个变量是只读的，只有在进程切换的时候才进行修改，并且整个切换和修改过程需要保证操作的原子性，目前至少需要屏蔽中断。可以参考 switch_to 的实现。</p>
<p>● static struct proc *initproc：本实验中，指向一个内核线程。本实验以后，此指针将指向第一个用户态进程。</p>
<p>● static list_entry_t hash_list[HASH_LIST_SIZE]：所有进程控制块的哈希表，proc_struct中的成员变量hash_link将基于pid链接入这个哈希表中。</p>
<p>● list_entry_t proc_list：所有进程控制块的双向线性列表，proc_struct中的成员变量list_link将链接入这个链表中。</p>
</section>
<section id="id3">
<h2>进程上下文<a class="headerlink" href="#id3" title="Link to this heading"></a></h2>
<p>进程上下文使用结构体<code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">context</span></code>保存，其中包含了<code class="docutils literal notranslate"><span class="pre">ra</span></code>，<code class="docutils literal notranslate"><span class="pre">sp</span></code>，<code class="docutils literal notranslate"><span class="pre">s0~s11</span></code>共14个寄存器。</p>
<p>可能感兴趣的同学就会问了，为什么我们不需要保存所有的寄存器呢？这里我们巧妙地利用了编译器对于函数的处理。我们知道寄存器可以分为调用者保存（caller-saved）寄存器和被调用者保存（callee-saved）寄存器。因为线程切换在一个函数当中（我们下一小节就会看到），所以编译器会自动帮助我们生成保存和恢复调用者保存寄存器的代码，在实际的进程切换过程中我们只需要保存被调用者保存寄存器就好啦！</p>
<p>下一小节，我们来看一看到底如何进行进程的切换。</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="页脚">
        <a href="lab4_3_1_lab_steps.html" class="btn btn-neutral float-left" title="实验执行流程概述" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
        <a href="lab4_3_3_create_exec_kernel_thread.html" class="btn btn-neutral float-right" title="创建并执行内核线程" accesskey="n" rel="next">下一页 <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2023, NKU OS LAB.</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用的 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a> 开发.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>